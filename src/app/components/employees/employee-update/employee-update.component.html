@if (pageLoading) {
  <div class="loading-container">
    <mat-spinner diameter="40" />
    <p>Loading employee data...</p>
  </div>
}

@if (!pageLoading) {
  <div class="form-container">
    <mat-card class="form-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>edit</mat-icon>
          Update Employee
        </mat-card-title>
        <mat-card-subtitle>Modify the employee information below.</mat-card-subtitle>
      </mat-card-header>

      <mat-card-content>
        <form [formGroup]="employeeForm" (ngSubmit)="onSubmit()" class="employee-form">
          <!-- Photo Upload -->
          <div class="photo-section">
            <div class="photo-preview">
              @if (imagePreview) {
                <img [src]="imagePreview" alt="Preview" class="preview-img" />
                <button mat-icon-button class="remove-photo" (click)="removePhoto()" type="button">
                  <mat-icon>close</mat-icon>
                </button>
              } @else {
                <div class="photo-placeholder">
                  <mat-icon>add_a_photo</mat-icon>
                </div>
              }
            </div>
            <button mat-stroked-button type="button" (click)="fileInput.click()">
              <mat-icon>upload</mat-icon>
              Change Photo
            </button>
            <input
              #fileInput
              type="file"
              accept="image/*"
              hidden
              (change)="onFileSelected($event)"
            />
          </div>

          <!-- Name Row -->
          <div class="form-row">
            <mat-form-field appearance="outline" class="half-width">
              <mat-label>First Name</mat-label>
              <input matInput formControlName="first_name" />
              @if (employeeForm.get('first_name')?.hasError('required') && employeeForm.get('first_name')?.touched) {
                <mat-error>First name is required</mat-error>
              }
            </mat-form-field>

            <mat-form-field appearance="outline" class="half-width">
              <mat-label>Last Name</mat-label>
              <input matInput formControlName="last_name" />
              @if (employeeForm.get('last_name')?.hasError('required') && employeeForm.get('last_name')?.touched) {
                <mat-error>Last name is required</mat-error>
              }
            </mat-form-field>
          </div>

          <!-- Email -->
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Email</mat-label>
            <input matInput formControlName="email" type="email" />
            <mat-icon matPrefix>email</mat-icon>
            @if (employeeForm.get('email')?.hasError('required') && employeeForm.get('email')?.touched) {
              <mat-error>Email is required</mat-error>
            }
            @if (employeeForm.get('email')?.hasError('email') && employeeForm.get('email')?.touched) {
              <mat-error>Please enter a valid email address</mat-error>
            }
          </mat-form-field>

          <!-- Gender & Department Row -->
          <div class="form-row">
            <mat-form-field appearance="outline" class="half-width">
              <mat-label>Gender</mat-label>
              <mat-select formControlName="gender">
                @for (g of genders; track g) {
                  <mat-option [value]="g">{{ g }}</mat-option>
                }
              </mat-select>
              @if (employeeForm.get('gender')?.hasError('required') && employeeForm.get('gender')?.touched) {
                <mat-error>Gender is required</mat-error>
              }
            </mat-form-field>

            <mat-form-field appearance="outline" class="half-width">
              <mat-label>Department</mat-label>
              <mat-select formControlName="department">
                @for (dept of departments; track dept) {
                  <mat-option [value]="dept">{{ dept }}</mat-option>
                }
              </mat-select>
              @if (employeeForm.get('department')?.hasError('required') && employeeForm.get('department')?.touched) {
                <mat-error>Department is required</mat-error>
              }
            </mat-form-field>
          </div>

          <!-- Designation -->
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Designation</mat-label>
            <input matInput formControlName="designation" />
            <mat-icon matPrefix>work</mat-icon>
            @if (employeeForm.get('designation')?.hasError('required') && employeeForm.get('designation')?.touched) {
              <mat-error>Designation is required</mat-error>
            }
          </mat-form-field>

          <!-- Salary & Date Row -->
          <div class="form-row">
            <mat-form-field appearance="outline" class="half-width">
              <mat-label>Salary</mat-label>
              <input matInput formControlName="salary" type="number" />
              <mat-icon matPrefix>attach_money</mat-icon>
              @if (employeeForm.get('salary')?.hasError('required') && employeeForm.get('salary')?.touched) {
                <mat-error>Salary is required</mat-error>
              }
              @if (employeeForm.get('salary')?.hasError('min') && employeeForm.get('salary')?.touched) {
                <mat-error>Salary must be at least $1,000</mat-error>
              }
            </mat-form-field>

            <mat-form-field appearance="outline" class="half-width">
              <mat-label>Date of Joining</mat-label>
              <input matInput [matDatepicker]="picker" formControlName="date_of_joining" />
              <mat-datepicker-toggle matSuffix [for]="picker" />
              <mat-datepicker #picker />
              @if (employeeForm.get('date_of_joining')?.hasError('required') && employeeForm.get('date_of_joining')?.touched) {
                <mat-error>Date of joining is required</mat-error>
              }
            </mat-form-field>
          </div>

          <!-- Actions -->
          <div class="form-actions">
            <button mat-stroked-button type="button" routerLink="/employees">
              <mat-icon>arrow_back</mat-icon>
              Cancel
            </button>
            <button
              mat-raised-button
              color="primary"
              type="submit"
              [disabled]="loading"
            >
              @if (loading) {
                <mat-spinner diameter="20" />
              } @else {
                <ng-container><mat-icon>save</mat-icon> Update Employee</ng-container>
              }
            </button>
          </div>
        </form>
      </mat-card-content>
    </mat-card>
  </div>
}
